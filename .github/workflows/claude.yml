name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          # claude_args: '--allowed-tools Bash(gh pr:*)'

  discord-notification:
    runs-on: ubuntu-latest
    needs: claude
    if: always()
    permissions:
      pull-requests: read
      issues: read
    steps:
      - name: Get Claude's comment
        id: get-comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            let issueNumber;
            let title;
            let url;
            let author;

            if (context.eventName === 'issue_comment') {
              issueNumber = context.payload.issue.number;
              title = context.payload.issue.title;
              url = context.payload.issue.html_url;
              author = context.payload.issue.user.login;
            } else if (context.eventName === 'pull_request_review_comment') {
              issueNumber = context.payload.pull_request.number;
              title = context.payload.pull_request.title;
              url = context.payload.pull_request.html_url;
              author = context.payload.pull_request.user.login;
            } else if (context.eventName === 'pull_request_review') {
              issueNumber = context.payload.pull_request.number;
              title = context.payload.pull_request.title;
              url = context.payload.pull_request.html_url;
              author = context.payload.pull_request.user.login;
            } else if (context.eventName === 'issues') {
              issueNumber = context.payload.issue.number;
              title = context.payload.issue.title;
              url = context.payload.issue.html_url;
              author = context.payload.issue.user.login;
            } else {
              core.setOutput('comment_body', '');
              return;
            }

            await new Promise(resolve => setTimeout(resolve, 5000));

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const claudeComment = comments.data
              .reverse()
              .find(comment => 
                comment.user.type === 'Bot' || 
                comment.user.login.includes('claude')
              );

            if (claudeComment) {
              core.setOutput('comment_body', claudeComment.body);
              core.setOutput('title', title);
              core.setOutput('url', url);
              core.setOutput('author', author);
            } else {
              core.setOutput('comment_body', '');
            }

      - name: Send to Discord
        if: steps.get-comment.outputs.comment_body != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CLAUDE_MESSAGE: ${{ steps.get-comment.outputs.comment_body }}
          TITLE: ${{ steps.get-comment.outputs.title }}
          URL: ${{ steps.get-comment.outputs.url }}
          AUTHOR: ${{ steps.get-comment.outputs.author }}
        run: |
          CLEANED_MESSAGE=$(echo "$CLAUDE_MESSAGE" | sed 's/[[:space:]]/ /g' | tr -d '\n' | sed 's/‚úÖ//g' | sed 's/‚ö†Ô∏è//g' | sed 's/üî¥//g' | sed 's/üü°//g' | sed 's/üîµ//g')
          TRUNCATED_MESSAGE="${CLEANED_MESSAGE:0:200}"
          if [ ${#CLEANED_MESSAGE} -gt 200 ]; then
            TRUNCATED_MESSAGE="${TRUNCATED_MESSAGE}..."
          fi

          curl -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg title "Claude Response: $TITLE" \
              --arg url "$URL" \
              --arg author "$AUTHOR" \
              --arg review "$TRUNCATED_MESSAGE" \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: 5814783,
                  fields: [
                    { name: "Author", value: $author, inline: true }
                  ],
                  description: $review
                }]
              }')" \
            "$DISCORD_WEBHOOK_URL"
