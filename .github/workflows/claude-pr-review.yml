name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing a pull request for the AGI Ventures Canada website, a Next.js 16 application with React 19. Provide constructive, actionable feedback.

            ## Critical: Review Scope

            **Only review the commits from the source branch being merged.** This means:
            - Review the new code being introduced by this PR's commits
            - Do NOT review or flag issues in the target branch (the branch being merged into)
            - Do NOT comment on pre-existing code that was already in the target branch
            - Ignore any issues in unchanged lines or files not touched by this PR

            Focus exclusively on what the PR author wrote in their commits.

            ### Git Commands to Use

            Use these commands to inspect the PR changes:

            - `git log origin/${{ github.event.pull_request.base.ref }}..HEAD --oneline` - Lists the commits being merged (from the PR branch, not the target branch)
            - `git diff origin/${{ github.event.pull_request.base.ref }}..HEAD` - Shows all changes introduced by the PR commits
            - `git diff origin/${{ github.event.pull_request.base.ref }}..HEAD -- <file>` - Shows changes to a specific file from the PR
            - `git show <commit-sha>` - Inspect a specific commit from the PR
            - `git diff origin/${{ github.event.pull_request.base.ref }}..HEAD --stat` - Summary of files changed and lines added/removed

            Do NOT extensively browse commits on the target branch. Only look at target branch code if needed for context on how the PR changes integrate.

            ### Keep Reviews Efficient

            **Match your effort to the PR size.**
            - **Small PRs** (copy changes, minor tweaks, a few lines): Quick review. Don't read unrelated files. Don't over-investigate. A text change doesn't need you to read the entire codebase.
            - **Medium PRs** (new component, feature addition): Read the changed files and immediate dependencies.
            - **Large PRs** (architectural changes, multiple features): More thorough review is appropriate.

            Start with `git diff --stat` to understand the scope. If it's just 1-2 files with minor changes, keep the review brief and focused.

            ## Project Standards to Enforce

            ### Architecture & Rendering
            - **Server-Side Pages**: All page components in `app/` directory MUST be server-side rendered. Flag any usage of `"use client"` directive in page files as a critical issue
            - **Client Components**: If client-side functionality is needed, it should be extracted into separate client components in the `components/` directory
            - **Path Aliases**: Use `@/` path alias for imports (e.g., `@/components/ui/button`)

            ### Code Quality
            - **No Inline Comments**: Code should be self-documenting. Flag any inline comments as they violate project standards
            - **TypeScript Strict Mode**: Ensure proper typing - no `any` types, proper interface definitions
            - **Clean Code**: Functions should be focused and readable without explanation

            ### UI Components
            - **shadcn/ui**: Base UI components should come from shadcn/ui (`@/components/ui/`)
            - **Radix Primitives**: Low-level components use Radix UI primitives
            - **Tailwind CSS**: Styling uses Tailwind with `tailwind-merge` and `class-variance-authority`
            - **Lucide Icons**: Use `lucide-react` for icons

            ### Package Management
            - **pnpm Only**: Ensure any dependency changes use pnpm, not npm or yarn
            - Flag any `package-lock.json` or `yarn.lock` files as they should not exist

            ### Commit Messages (for PR title/description)
            Follow Conventional Commits format:
            - `feat:` - New features
            - `fix:` - Bug fixes
            - `docs:` - Documentation changes
            - `style:` - Formatting changes (not CSS)
            - `refactor:` - Code restructuring
            - `perf:` - Performance improvements
            - `chore:` - Maintenance tasks

            ## Review Focus Areas

            1. **Breaking Changes**: Does this PR introduce breaking changes to existing functionality?
            2. **Performance**: Are there any performance concerns (large images, unnecessary re-renders, missing optimizations)?
            3. **Accessibility**: Are proper ARIA attributes, semantic HTML, and keyboard navigation considered?
            4. **Security**: Any security concerns (XSS vulnerabilities, exposed secrets)?
            5. **Next.js Best Practices**:
               - Proper use of `Image` component from `next/image`
               - Correct usage of `Link` from `next/link`
               - Metadata properly defined for SEO
               - Server vs Client component decisions

            ## Response Format

            Structure your review as follows:

            **Review**: One sentence summarizing the overall state of this PR (e.g., Overall no major issues except X).

            **What it does**: One sentence describing what this PR does.

            ---

            ### âœ… What's Good

            Highlight positive aspects of the PR.

            ### âš ï¸ Issues Found

            List any violations of project standards or concerns, ordered by severity:
            - ðŸ”´ **Critical**: Must be fixed before merge
            - ðŸŸ¡ **Warning**: Should be addressed
            - ðŸ”µ **Suggestion**: Nice to have improvements

            ---

            Review only the commits from the source branch being merged into the target branch. Focus on what the PR author wrote â€” not what already exists in the target branch.

            Use the repository's CLAUDE.md for additional guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

  discord-notification:
    runs-on: ubuntu-latest
    needs: claude-review
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: read
    steps:
      - name: Get Claude's comment
        id: get-comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const claudeComment = comments.data
              .reverse()
              .find(comment => 
                comment.user.type === 'Bot' || 
                comment.user.login.includes('claude') ||
                comment.body.includes('**Review**:') ||
                comment.body.includes('âœ… What\'s Good')
              );

            if (claudeComment) {
              core.setOutput('comment_body', claudeComment.body);
            } else {
              core.setOutput('comment_body', 'Claude review completed but comment not found.');
            }

      - name: Send to Discord
        if: steps.get-comment.outputs.comment_body != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CLAUDE_MESSAGE: ${{ steps.get-comment.outputs.comment_body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          TRUNCATED_MESSAGE="${CLAUDE_MESSAGE:0:500}"
          if [ ${#CLAUDE_MESSAGE} -gt 500 ]; then
            TRUNCATED_MESSAGE="${TRUNCATED_MESSAGE}..."
          fi

          curl -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg title "ðŸ¤– Claude Review: $PR_TITLE" \
              --arg url "$PR_URL" \
              --arg author "$PR_AUTHOR" \
              --arg review "$TRUNCATED_MESSAGE" \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: 5814783,
                  fields: [
                    { name: "Author", value: $author, inline: true }
                  ],
                  description: $review
                }]
              }')" \
            "$DISCORD_WEBHOOK_URL"
